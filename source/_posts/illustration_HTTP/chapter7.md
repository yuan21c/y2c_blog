---
title: 《图解HTTP》第七章 确保 Web 安全的HTTPS
date: 2022-09-20 23:31:54
updated: 2022-09-20 23:31:54
categories: 图解HTTP
tags: 
    - web
    - HTTP
    - WWW
description: 
top_img: https://iili.io/66LbYF.jpg
cover: https://iili.io/66LxqB.jpg
---

## HTTP 的缺点

HTTTP 的主要不足：

+ 通信使用明文，内容可能会被窃听
+ 不验证通信方的身份，因此可能遭遇伪装
+ 无法证明报文的完整性，所以报文有可能已遭篡改

### 通信使用明文可能会被窃听

#### TCP/IP 是可能被窃听的网络

按 TCP/IP 协议族的工作机制，通信内容在所有的通信线路上都有可能遭到窥视。与加密与否无关，只是加密后可能让人无法破解报文信息。

#### 加密处理防止被窃听

+ 通信的加密

    通过和 SSL (Secure Socket Layer, 安全套接层) 或 TLS (Transport Layer Security, 安全传输层协议) 的组合使用，加密 HTTP 的通信内容。

    与 SSL 组合使用的 HTTP 被称为 HTTPS (HTTP Secure) 或 HTTP over SSL 。

+ 内容的加密

    把 HTTP 报文（指报文主体，报文头部是不加密的）里包含的内容进行加密处理。但内容仍有[被篡改的可能](#如何防止篡改)。

    为了做到有效的内容加密，要求客户端和服务器同时具备加密和解密机制。

### 不验证通信方的身份就可能遭遇伪装

HTTP 协议中的请求和响应不会对通信方进行确认。

#### 任何人都可以发起请求

存在的隐患：

+ 无法确定请求发送至目标的 Web 服务器是否是按真实意图返回响应的那台服务器。有可能是已伪装的 + Web 服务器。

+ 无法确定响应返回到的客户端是否是按真实意图接收响应的那个客户端。有可能是已伪装的客户端。

+ 无法确定正在通信的对方是否具备访问权限。因为某些 Web 服务器上保存着重要的信息，只想发给特定+ 用户通信的权限。

+ 无法判定请求是来自何方、出自谁手。

+ 即使是无意义的请求也会照单全收。无法阻止海量请求下的 DoS 攻击（Denial of Service，拒绝服+ 务攻击）。

#### 查明对手的证书

SSL 通过证书确认通信方。证书由值得[信任](/white_hat/chapter01/#返璞归真，揭密安全的本质)的第三方机构颁发。

### 无法证明报文的完整性，可能已遭篡改

#### 接收到的内容可能有误

HTTP 无法确认发出的请求 / 响应和接收到的请求 / 响应是前后相同的。

请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击称为中间人攻击 ( Man-in-the-Middle attack, MITM) 。

#### 如何防止篡改

HTTP 可以使用 MD5 和 SHA-1 等散列值校验的方法以及用来确认文件的数字签名 ( 如: PGP,Pretty Good Privacy, 完美隐私 ) 的方法来确定报文的完整性。

但这些操作需要用户亲自检查验证，浏览器无法自动帮用户检查。

而且， 如果 PGP 和 MD5 本身被篡改则无法被验证出来。

SSL 提供认证和加密处理及摘要问题功能。

## HTTP + 加密 + 认证 + 完整性保护 = HTTPS

### HTTP 加上加密处理和认证以及完整性保护后即是 HTTPS

我们把添加了加密及认证机制的 HTTP 称为 HTTPS（HTTP Secure）。

### HTTPS 是身披 SSL 外壳的 HTTP

HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（Secure Socket Layer）和 TLS（Transport Layer Security）协议代替而已。

通常，HTTP 直接和 TCP 通信。当使用 SSL 时，则演变成先和 SSL 通信，再由 SSL 和 TCP 通信了。简言之，所谓 HTTPS，其实就是身披 SSL 协议这层外壳的 HTTP。

SSL 是独立于 HTTP 的协议，所以不光是 HTTP 协议，其他运行在应用层的 SMTP 和 Telnet 等协议均可配合 SSL 协议使用。可以说 SSL 是当今世界上应用最为广泛的网络安全技术。

### 相互交换密钥的公开密钥加密技术

HTTPS 混合使用对称加密和非对称加密技术。

非对称技术更安全，但效率低。

### 证明公钥正确性的证书

### HTTPS 的安全通信机制

![HTTPS 通信步骤](https://iili.io/ig2HMX.jpg)

1. 客户端通过发送 Client Hello 报文开始 SSL 通信。报文中包含客户端支持的 SSL 的指定版本、加密组件（Cipher Suite）列表（所使用的加密算法及密钥长度等）。

2. 服务器可进行 SSL 通信时，会以 Server Hello 报文作为应答。和客户端一样，在报文中包含 SSL 版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的。

3. 之后服务器发送 Certificate 报文。报文中包含公开密钥证书。

4. 最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的 SSL 握手协商部分结束。

5. SSL 第一次握手结束之后，客户端以 Client Key Exchange 报文作为回应。报文中包含通信加密中使用的一种被称为 Pre-master secret 的随机密码串。该报文已用步骤 3 中的公开密钥进行加密。

6. 接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre-master secret 密钥加密。

7. 客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。

8. 服务器同样发送 Change Cipher Spec 报文。

9. 服务器同样发送 Finished 报文。

10. 服务器和客户端的 Finished 报文交换完毕之后，SSL 连接就算建立完成。当然，通信会受到 SSL 的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。

11. 应用层协议通信，即发送 HTTP 响应。

12. 最后由客户端断开连接。断开连接时，发送 close_notify 报文。上图做了一些省略，这步之后再发送 TCP FIN 报文来关闭与 TCP的通信。

在以上流程中，应用层发送数据时会附加一种叫做 **MAC（Message Authentication Code）** 的报文摘要。MAC 能够查知报文是否遭到篡改，从而保护报文的完整性。

#### SSL 和 TLS

SSL 技术最初是由浏览器开发商网景通信公司率先倡导的，开发过 SSL3.0 之前的版本。目前主导权已转移到 IETF（Internet Engineering Task Force, Internet 工程任务组）的手中。

IETF 以 SSL3.0 为基准，后又制定了 TLS1.0、TLS1.1 和 TLS1.2。TSL 是以 SSL 为原型开发的协议，有时会统一称该协议为 SSL。

#### SSL 通信速度慢

+ 通信慢

    除去和 TCP 连接、发送 HTTP 请求 • 响应以外，还必须进行 SSL 通信，因此整体上处理通信量不可避免会增加。

+ 由于大量消耗 CPU 及内存等资源，导致处理速度变慢。

    SSL 必须进行加密处理。在服务器和客户端都需要进行加密和解密的运算处理。因此从结果上讲，比起 HTTP 会更多地消耗服务器和客户端的硬件资源，导致负载增强。
